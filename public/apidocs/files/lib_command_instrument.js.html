<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/command/instrument.js - The Istanbul API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="The Istanbul API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/CoberturaReport.html">CoberturaReport</a></li>
            
                <li><a href="../classes/Collector.html">Collector</a></li>
            
                <li><a href="../classes/Hook.html">Hook</a></li>
            
                <li><a href="../classes/HtmlReport.html">HtmlReport</a></li>
            
                <li><a href="../classes/Instrumenter.html">Instrumenter</a></li>
            
                <li><a href="../classes/JsonReport.html">JsonReport</a></li>
            
                <li><a href="../classes/LcovOnlyReport.html">LcovOnlyReport</a></li>
            
                <li><a href="../classes/LcovReport.html">LcovReport</a></li>
            
                <li><a href="../classes/LookupStore.html">LookupStore</a></li>
            
                <li><a href="../classes/MemoryStore.html">MemoryStore</a></li>
            
                <li><a href="../classes/ObjectUtils.html">ObjectUtils</a></li>
            
                <li><a href="../classes/Report.html">Report</a></li>
            
                <li><a href="../classes/Store.html">Store</a></li>
            
                <li><a href="../classes/TeamcityReport.html">TeamcityReport</a></li>
            
                <li><a href="../classes/TextReport.html">TextReport</a></li>
            
                <li><a href="../classes/TextSummaryReport.html">TextSummaryReport</a></li>
            
                <li><a href="../classes/TmpStore.html">TmpStore</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/istanbul.html">istanbul</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/command/instrument.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 Copyright (c) 2012, Yahoo! Inc.  All rights reserved.
 Copyrights licensed under the New BSD License. See the accompanying LICENSE file for terms.
 */

var path = require(&#x27;path&#x27;),
    mkdirp = require(&#x27;mkdirp&#x27;),
    async = require(&#x27;async&#x27;),
    fs = require(&#x27;fs&#x27;),
    filesFor = require(&#x27;../util/file-matcher&#x27;).filesFor,
    nopt = require(&#x27;nopt&#x27;),
    Instrumenter = require(&#x27;../instrumenter&#x27;),
    inputError = require(&#x27;../util/input-error&#x27;),
    formatOption = require(&#x27;../util/help-formatter&#x27;).formatOption,
    util = require(&#x27;util&#x27;),
    Command = require(&#x27;./index&#x27;),
    Collector = require(&#x27;../collector&#x27;),
    flowControl = require(&#x27;../util/flow-control&#x27;),
    verbose;


/**
 * Chunk file size to use when reading non JavaScript files in memory
 * and copying them over when using complete-copy flag.
 */
var READ_FILE_CHUNK_SIZE = 64 * 1024;

function BaselineCollector(instrumenter) {
    this.instrumenter = instrumenter;
    this.collector = new Collector();
    this.instrument = instrumenter.instrument.bind(this.instrumenter);

    var origInstrumentSync = instrumenter.instrumentSync;
    this.instrumentSync = function () {
        var args = Array.prototype.slice.call(arguments),
            ret = origInstrumentSync.apply(this.instrumenter, args),
            baseline = this.instrumenter.lastFileCoverage(),
            coverage = {};
        coverage[baseline.path] = baseline;
        this.collector.add(coverage);
        return ret;
    };
    //monkey patch the instrumenter to call our version instead
    instrumenter.instrumentSync = this.instrumentSync.bind(this);
}

BaselineCollector.prototype = {
    getCoverage: function () {
        return this.collector.getFinalCoverage();
    }
};


function processFiles(instrumenter, inputDir, outputDir, relativeNames) {
    var processor = function (name, callback) {
            var inputFile = path.resolve(inputDir, name),
                outputFile = path.resolve(outputDir, name),
                inputFileExtenstion = path.extname(inputFile),
                isJavaScriptFile = (inputFileExtenstion === &#x27;.js&#x27;),
                oDir = path.dirname(outputFile),
                readStream, writeStream;

            callback = flowControl.callOnce(callback);
            mkdirp.sync(oDir);

            if (fs.statSync(inputFile).isDirectory()) {
                return callback(null, name);
            }

            if (isJavaScriptFile) {
                fs.readFile(inputFile, &#x27;utf8&#x27;, function (err, data) {
                    if (err) { return callback(err, name); }
                    instrumenter.instrument(data, inputFile, function (iErr, instrumented) {
                        if (iErr) { return callback(iErr, name); }
                        fs.writeFile(outputFile, instrumented, &#x27;utf8&#x27;, function (err) {
                            return callback(err, name);
                        });
                    });
                });
            }
            else {
                // non JavaScript file, copy it as is
                readStream = fs.createReadStream(inputFile, {&#x27;bufferSize&#x27;: READ_FILE_CHUNK_SIZE});
                writeStream = fs.createWriteStream(outputFile);

                readStream.on(&#x27;error&#x27;, callback);
                writeStream.on(&#x27;error&#x27;, callback);

                readStream.pipe(writeStream);
                readStream.on(&#x27;end&#x27;, function() {
                    callback(null, name);
                });
            }
        },
        q = async.queue(processor, 10),
        errors = [],
        count = 0,
        startTime = new Date().getTime();

    q.push(relativeNames, function (err, name) {
        var inputFile, outputFile;
        if (err) {
            errors.push({ file: name, error: err.message || err.toString() });
            inputFile = path.resolve(inputDir, name);
            outputFile = path.resolve(outputDir, name);
            fs.writeFileSync(outputFile, fs.readFileSync(inputFile));
        }
        if (verbose) {
            console.log(&#x27;Processed: &#x27; + name);
        } else {
            if (count % 100 === 0) { process.stdout.write(&#x27;.&#x27;); }
        }
        count += 1;
    });

    q.drain = function () {
        var endTime = new Date().getTime();
        console.log(&#x27;\nProcessed [&#x27; + count + &#x27;] files in &#x27; + Math.floor((endTime - startTime) / 1000) + &#x27; secs&#x27;);
        if (errors.length &gt; 0) {
            console.log(&#x27;The following &#x27; + errors.length + &#x27; file(s) had errors and were copied as-is&#x27;);
            console.log(errors);
        }
    };
}


function InstrumentCommand() {
    Command.call(this);
}

InstrumentCommand.TYPE = &#x27;instrument&#x27;;
util.inherits(InstrumentCommand, Command);

Command.mix(InstrumentCommand, {
    synopsis: function synopsis() {
        return &quot;instruments a file or a directory tree and writes the instrumented code to the desired output location&quot;;
    },

    usage: function () {
        console.error(&#x27;\nUsage: &#x27; + this.toolName() + &#x27; &#x27; + this.type() + &#x27; &lt;options&gt; &lt;file-or-directory&gt;\n\nOptions are:\n\n&#x27; +
            [
                formatOption(&#x27;--output &lt;file-or-dir&gt;&#x27;, &#x27;The output file or directory. This is required when the input is a directory, &#x27; +
                    &#x27;defaults to standard output when input is a file&#x27;),
                formatOption(&#x27;-x &lt;exclude-pattern&gt; [-x &lt;exclude-pattern&gt;]&#x27;, &#x27;one or more fileset patterns (e.g. &quot;**/vendor/**&quot; to ignore all files &#x27; +
                    &#x27;under a vendor directory). Also see the --default-excludes option&#x27;),
                formatOption(&#x27;--variable &lt;global-coverage-variable-name&gt;&#x27;, &#x27;change the variable name of the global coverage variable from the &#x27; +
                    &#x27;default value of &#x60;__coverage__&#x60; to something else&#x27;),
                formatOption(&#x27;--embed-source&#x27;, &#x27;embed source code into the coverage object, defaults to false&#x27;),
                formatOption(&#x27;--[no-]compact&#x27;, &#x27;produce [non]compact output, defaults to compact&#x27;),
                formatOption(&#x27;--[no-]preserve-comments&#x27;, &#x27;remove / preserve comments in the output, defaults to false&#x27;),
                formatOption(&#x27;--[no-]complete-copy&#x27;, &#x27;also copy non-javascript files to the ouput directory as is, defaults to false&#x27;),
                formatOption(&#x27;--save-baseline&#x27;, &#x27;produce a baseline coverage.json file out of all files instrumented&#x27;),
                formatOption(&#x27;--baseline-file &lt;file&gt;&#x27;, &#x27;filename of baseline file, defaults to coverage/coverage-baseline.json&#x27;)
            ].join(&#x27;\n\n&#x27;) + &#x27;\n&#x27;);
        console.error(&#x27;\n&#x27;);
    },

    run: function (args, callback) {

        var config = {
                output: path,
                x: [Array, String],
                variable: String,
                compact: Boolean,
                &#x27;complete-copy&#x27;: Boolean,
                verbose: Boolean,
                &#x27;save-baseline&#x27;: Boolean,
                &#x27;baseline-file&#x27;: path,
                &#x27;embed-source&#x27;: Boolean,
                &#x27;preserve-comments&#x27;: Boolean
            },
            opts = nopt(config, { v : &#x27;--verbose&#x27; }, args, 0),
            cmdArgs = opts.argv.remain,
            file,
            stats,
            stream,
            includes,
            instrumenter = new Instrumenter({ coverageVariable: opts.variable }),
            needBaseline = opts[&#x27;save-baseline&#x27;],
            baselineFile = opts[&#x27;baseline-file&#x27;] || path.resolve(process.cwd(), &#x27;coverage&#x27;, &#x27;coverage-baseline.json&#x27;);

        verbose = opts.verbose;
        if (cmdArgs.length !== 1) {
            return callback(inputError.create(&#x27;Need exactly one filename/ dirname argument for the instrument command!&#x27;));
        }
        if (typeof opts.compact === &#x27;undefined&#x27;) {
            opts.compact = true;
        }
        if (typeof opts[&#x27;complete-copy&#x27;] === &#x27;undefined&#x27;) {
            // false for backward compatibility
            opts[&#x27;complete-copy&#x27;] = false;
        }

        if (opts[&#x27;complete-copy&#x27;]) {
            includes = [&#x27;**/*&#x27;];
        }
        else {
            includes = [&#x27;**/*.js&#x27;];
        }

        instrumenter = new Instrumenter({
            coverageVariable: opts.variable,
            embedSource: opts[&#x27;embed-source&#x27;],
            noCompact: !opts.compact,
            preserveComments: opts[&#x27;preserve-comments&#x27;]
        });

        if (needBaseline) {
            mkdirp.sync(path.dirname(baselineFile));
            instrumenter = new BaselineCollector(instrumenter);
            process.on(&#x27;exit&#x27;, function () {
                util.puts(&#x27;Saving baseline coverage at: &#x27; + baselineFile);
                fs.writeFileSync(baselineFile, JSON.stringify(instrumenter.getCoverage()), &#x27;utf8&#x27;);
            });
        }

        file = path.resolve(cmdArgs[0]);
        stats = fs.statSync(file);
        if (stats.isDirectory()) {
            if (!opts.output) { return callback(inputError.create(&#x27;Need an output directory [-o &lt;dir&gt;] when input is a directory!&#x27;)); }
            if (opts.output === file) { return callback(inputError.create(&#x27;Cannot instrument into the same directory/ file as input!&#x27;)); }
            mkdirp.sync(opts.output);
            filesFor({
                root: file,
                includes: includes,
                excludes: opts.x || [&#x27;**/node_modules/**&#x27;],
                relative: true
            }, function (err, files) {
                if (err) { return callback(err); }
                processFiles(instrumenter, file, opts.output, files);
            });
        } else {
            if (opts.output) {
                stream = fs.createWriteStream(opts.output);
            } else {
                stream = process.stdout;
            }
            stream.write(instrumenter.instrumentSync(fs.readFileSync(file, &#x27;utf8&#x27;), file));
            if (stream !== process.stdout) {
                stream.end();
            }
        }
    }
});

module.exports = InstrumentCommand;


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
