<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>misc/samples/coverage.js - The Istanbul API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="The Istanbul API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/API.html">API</a></li>
            
                <li><a href="../classes/CoberturaReport.html">CoberturaReport</a></li>
            
                <li><a href="../classes/Collector.html">Collector</a></li>
            
                <li><a href="../classes/Hook.html">Hook</a></li>
            
                <li><a href="../classes/HtmlReport.html">HtmlReport</a></li>
            
                <li><a href="../classes/Instrumenter.html">Instrumenter</a></li>
            
                <li><a href="../classes/JsonReport.html">JsonReport</a></li>
            
                <li><a href="../classes/LcovOnlyReport.html">LcovOnlyReport</a></li>
            
                <li><a href="../classes/LcovReport.html">LcovReport</a></li>
            
                <li><a href="../classes/LookupStore.html">LookupStore</a></li>
            
                <li><a href="../classes/MemoryStore.html">MemoryStore</a></li>
            
                <li><a href="../classes/ObjectUtils.html">ObjectUtils</a></li>
            
                <li><a href="../classes/Report.html">Report</a></li>
            
                <li><a href="../classes/Store.html">Store</a></li>
            
                <li><a href="../classes/TeamcityReport.html">TeamcityReport</a></li>
            
                <li><a href="../classes/TextReport.html">TextReport</a></li>
            
                <li><a href="../classes/TextSummaryReport.html">TextSummaryReport</a></li>
            
                <li><a href="../classes/TmpStore.html">TmpStore</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/istanbul.html">istanbul</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: misc/samples/coverage.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var path = require(&#x27;path&#x27;),
    fs = require(&#x27;fs&#x27;),
    istanbul = require(&#x27;istanbul&#x27;),
    hook = istanbul.hook,
    Instrumenter = istanbul.Instrumenter,
    Collector = istanbul.Collector,
    instrumenter = new Instrumenter(),
    Report = istanbul.Report,
    collector,
    globalAdded = false,
    fileMap = {};

/**
 * Facade for all coverage operations support node as well as browser cases
 *
 * Usage:
 * &#x60;&#x60;&#x60;
 *  //Node unit tests
 *  var coverage = require(&#x27;/path/to/this/file&#x27;);
 *  coverage.hookRequire(); // hooks require for instrumentation
 *  coverage.addInstrumentCandidate(file); // adds a file that needs to be instrumented; should be called before file is &#x60;require&#x60;d
 *
 *  //Browser tests
 *  var coverage = require(&#x27;/path/to/this/file&#x27;);
 *  var instrumentedCode = coverage.instrumentFile(file); //alternatively, use &#x60;instrumentCode&#x60; if you have already loaded the code
 *  //collect coverage from the browser
 *  // this coverage will be stored as &#x60;window.__coverage__&#x60;
 *  // and...
 *  coverage.addCoverage(coverageObject); // rinse and repeat
 *  &#x60;&#x60;&#x60;
 *
 *  //in all cases, add an exit handler to the process
 *  process.once(&#x27;exit&#x27;, function () { coverage.writeReports(outputDir); }); //write coverage reports
 */

/**
 * adds a file as a candidate for instrumentation when require is hooked
 * @method addInstrumentCandidate
 * @param file the file to add as an instrumentation candidate
 */
function addInstrumentCandidate(file) {
    file = path.resolve(file);
    fileMap[file] = true;
}
/**
 * hooks require to instrument all files that have been specified as instrumentation candidates
 * @method hookRequire
 * @param verbose true for debug messages
 */
function hookRequire(verbose) {

    var matchFn = function (file) {
        var match = fileMap[file],
            what = match ? &#x27;Hooking&#x27; : &#x27;NOT hooking&#x27;;
        if (verbose) { console.log(what + file); }
        return match;
    }, transformFn = instrumenter.instrumentSync.bind(instrumenter);

    hook.hookRequire(matchFn, transformFn);
}
/**
 * unhooks require hooks that have been installed
 * @method unhookRequire
 */
function unhookRequire() {
    hook.unhookRequire();
}
/**
 * returns the coverage collector, creating one if necessary and automatically
 * adding the contents of the global coverage object. You can use this method
 * in an exit handler to get the accumulated coverage.
 */
function getCollector() {
    if (!collector) {
        collector = new Collector();
    }

    if (globalAdded) { return collector; }

    if (global[&#x27;__coverage__&#x27;]) {
        collector.add(global[&#x27;__coverage__&#x27;]);
        globalAdded = true;
    } else {
        console.error(&#x27;No global coverage found for the node process&#x27;);
    }
    return collector;
}
/**
 * adds coverage to the collector for browser test cases
 * @param coverageObject the coverage object to add
 */
function addCoverage(coverageObject) {
    if (!collector) { collector = new Collector(); }
    collector.add(coverageObject);
}
/**
 * returns the merged coverage for the collector
 */
function getFinalCoverage() {
    return getCollector().getFinalCoverage();
}

/**
 * writes reports for an array of JSON files representing partial coverage information
 * @method writeReportsFor
 * @param fileList array of file names containing partial coverage objects
 * @param dir the output directory for reports
 */
function writeReportsFor(fileList, dir) {
    var collector = new Collector();
    fileList.forEach(function (file) {
        var coverage = JSON.parse(fs.readFileSync(file, &#x27;utf8&#x27;));
        collector.addCoverage(coverage);
    });
    writeReportsInternal(dir, collector);
}

/**
 * writes reports for everything accumulated by the collector
 * @method writeReports
 * @param dir the output directory for reports
 */
function writeReports(dir) {
    writeReportsInternal(dir, getCollector());
}

function writeReportsInternal(dir, collector) {
    dir = dir || process.cwd();
    var reports = [
        Report.create(&#x27;lcov&#x27;, { dir: dir }),
        Report.create(&#x27;text&#x27;),
        Report.create(&#x27;text-summary&#x27;)
    ];
    reports.forEach(function (report) { report.writeReport(collector, true); })
}
/**
 * returns the instrumented version of the code specified
 * @param {String} code the code to instrument
 * @param {String} file the file from which the code was load
 * @return {String} the instrumented version of the code in the file
 */
function instrumentCode(code, filename) {
    filename = path.resolve(filename);
    return instrumenter.instrumentSync(code, filename);
}
/**
 * returns the instrumented version of the code present in the specified file
 * @param file the file to load
 * @return {String} the instrumented version of the code in the file
 */
function instrumentFile(file) {
    filename = path.resolve(file);
    return instrumentCode(fs.readFileSync(file, &#x27;utf8&#x27;), file);
}

module.exports = {
    addInstrumentCandidate: addInstrumentCandidate,
    hookRequire: hookRequire,
    unhookRequire: unhookRequire,
    instrumentCode: instrumentCode,
    instrumentFile: instrumentFile,
    addCoverage: addCoverage,
    writeReports: writeReports
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
